name: Code Coverage

permissions:
  contents: read
  id-token: write

on: 
  pull_request:
    branches: [ master ]
    paths:
      - .github/workflows/code-coverage.yml
      - alias
      - awscli.sh
      - test_awscli.sh
      - Dockerfile
  workflow_dispatch:

jobs:
  awscli-test:
    runs-on: macos-latest

    steps:
    - name: Checkout Project
      uses: actions/checkout@v5
    
    - name: Install Dependencies and Run Tests
      run: |
        # Install Homebrew (if not already installed) and kcov
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)" || true
        brew install kcov

        # Configure pip for system packages
        mkdir -p ~/.config/pip/ && echo "[global]" > ~/.config/pip/pip.conf
        echo "break-system-packages = true" >> ~/.config/pip/pip.conf

        # Download shunit2
        curl -sSL https://raw.githubusercontent.com/kward/shunit2/master/shunit2 -o shunit2
        chmod +x shunit2

        # Run unit tests and generate coverage
        kcov kcov-output ./test_awscli.sh

    - name: Upload coverage to Codecov
      run: kcov upload-coverage --fail-on-error --git-service github --sha ${{ github.sha }} --dir ./kcov-output --gcov-executable gcov --token ${{ secrets.CODECOV_TOKEN }}

name: Code Coverage

permissions:
  contents: read

on: 
  pull_request:
    branches: [ master ]
    paths:
      - alias
      - awscli.sh
      - test_awscli.sh
      - Dockerfile
  workflow_dispatch:

jobs:
  awscli-test:
    runs-on: macos-latest

    steps:
    - name: Checkout Project
      uses: actions/checkout@v5
    
    - name: Install Dependencies and Run Tests
      run: |
        # Install Homebrew (if not already installed) and jq, python3, kcov
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)" || true
        brew install jq python3 kcov

        # Configure pip for system packages
        mkdir -p ~/.config/pip/ && echo "[global]" > ~/.config/pip/pip.conf
        echo "break-system-packages = true" >> ~/.config/pip/pip.conf

        # Download shunit2
        curl -sSL https://raw.githubusercontent.com/kward/shunit2/master/shunit2 > LanikSJ/awscli-aliases/shunit2

        # Generate coverage for awscli.sh (this will execute awscli.sh once)
        # The output will be in kcov-output/
        kcov LanikSJ/awscli-aliases/kcov-output LanikSJ/awscli-aliases/awscli.sh

        # Run unit tests
        bash LanikSJ/awscli-aliases/test_awscli.sh

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        directory: ./LanikSJ/awscli-aliases/kcov-output # Directory where kcov outputs reports
        fail_ci_if_error: true # Optional: fail CI if Codecov upload fails

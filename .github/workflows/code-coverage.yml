name: Code Coverage

permissions:
  contents: read
  id-token: write

on: 
  pull_request:
    branches: [ master ]
    paths:
      - .github/workflows/code-coverage.yml
      - alias
      - awscli.sh
      - test_awscli.sh
      - Dockerfile
  workflow_dispatch:

jobs:
  awscli-test:
    runs-on: macos-latest

    steps:
    - name: Checkout Project
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    
    - name: Install Dependencies and Run Tests
      run: |
        # Install Homebrew (if not already installed) and kcov
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)" || true
        brew install kcov

        # Configure pip for system packages
        mkdir -p ~/.config/pip/ && echo "[global]" > ~/.config/pip/pip.conf
        echo "break-system-packages = true" >> ~/.config/pip/pip.conf

        # Download shunit2
        curl -sSL https://raw.githubusercontent.com/kward/shunit2/master/shunit2 -o shunit2
        chmod +x shunit2

        # Run unit tests and generate coverage
        kcov kcov-output ./test_awscli.sh

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@fdcc8476540edceab3de004e990f80d881c6cc00 # v5.5.0
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        directory: ./kcov-output # Directory where kcov outputs reports, relative to working-directory
        fail_ci_if_error: true # Optional: fail CI if Codecov upload fails
